# HG changeset patch
# Parent  548d0a2f3a22bfac32ec0c3921c6c969c8bf32a9

diff -r 548d0a2f3a22 -r 03359dcf2ddd gfx/2d/ConvolutionFilter.cpp
--- a/gfx/2d/ConvolutionFilter.cpp	Mon Jul 22 16:57:54 2019 +0200
+++ b/gfx/2d/ConvolutionFilter.cpp	Thu Jul 25 08:51:51 2019 +0200
@@ -6,6 +6,7 @@
 
 #include "2D.h"
 #include "ConvolutionFilter.h"
+#include "mozilla/gfx/Swizzle.h"
 #include "skia/src/core/SkBitmapFilter.h"
 #include "skia/src/core/SkConvolver.h"
 #include "skia/src/core/SkOpts.h"
@@ -40,6 +41,15 @@
   SkOpts::convolve_horizontally(aSrc, *mFilter, aDst, aHasAlpha);
 }
 
+static void ByteSwapArray(uint8_t *u8Array, int32_t size) {
+    uint32_t *array = reinterpret_cast<uint32_t*>(u8Array);
+    for (int pxl = 0; pxl < size; ++pxl) {
+        // Use an endian swap to move the bytes, i.e. BGRA -> ARGB.
+        uint32_t rgba = array[pxl];
+        array[pxl] = NativeEndian::swapToLittleEndian(rgba);
+    }
+}
+
 void ConvolutionFilter::ConvolveVertically(uint8_t* const* aSrc, uint8_t* aDst,
                                            int32_t aRowIndex, int32_t aRowSize,
                                            bool aHasAlpha) {
@@ -49,8 +59,26 @@
   int32_t filterLength;
   auto filterValues =
       mFilter->FilterForValue(aRowIndex, &filterOffset, &filterLength);
+
+#ifdef MOZ_BIG_ENDIAN
+  for (int filterY = 0; filterY < filterLength; filterY++) {
+      // Skia only knows LE, so we have to swizzle the input
+    ByteSwapArray(aSrc[filterY], aRowSize);
+  }
+#endif
+
   SkOpts::convolve_vertically(filterValues, filterLength, aSrc, aRowSize, aDst,
                               aHasAlpha);
+
+#ifdef MOZ_BIG_ENDIAN
+  // After skia is finished, we swizzle back to BE, in case
+  // the input is used again somewhere else
+  for (int filterY = 0; filterY < filterLength; filterY++) {
+    ByteSwapArray(aSrc[filterY], aRowSize);
+  }
+  // The destination array as well
+  ByteSwapArray(aDst, aRowSize);
+#endif
 }
 
 /* ConvolutionFilter::ComputeResizeFactor is derived from Skia's
diff -r 548d0a2f3a22 -r 03359dcf2ddd gfx/skia/skia/include/core/SkPreConfig.h
--- a/gfx/skia/skia/include/core/SkPreConfig.h	Mon Jul 22 16:57:54 2019 +0200
+++ b/gfx/skia/skia/include/core/SkPreConfig.h	Thu Jul 25 08:51:51 2019 +0200
@@ -73,7 +73,7 @@
       defined(__ppc__) || defined(__hppa) || \
       defined(__PPC__) || defined(__PPC64__) || \
       defined(_MIPSEB) || defined(__ARMEB__) || \
-      defined(__s390__) || \
+      defined(__s390__) || defined(__s390x__) || \
       (defined(__sh__) && defined(__BIG_ENDIAN__)) || \
       (defined(__ia64) && defined(__BIG_ENDIAN__))
          #define SK_CPU_BENDIAN
diff -r 548d0a2f3a22 -r 03359dcf2ddd image/decoders/nsIconDecoder.cpp
--- a/image/decoders/nsIconDecoder.cpp	Mon Jul 22 16:57:54 2019 +0200
+++ b/image/decoders/nsIconDecoder.cpp	Thu Jul 25 08:51:51 2019 +0200
@@ -93,6 +93,9 @@
     memcpy(&pixel, aData, 4);
     aData += 4;
     aLength -= 4;
+#if MOZ_BIG_ENDIAN
+    pixel = NativeEndian::swapFromLittleEndian(pixel);
+#endif
 
     return AsVariant(pixel);
   });
